project: dino
name: dinov3_reference
method: grid
metric:
  name: valid_loss
  goal: minimize

parameters:
  # Run behavior
  log_to_wandb:
    value: true
  debug:
    value: false
  sanity_run:
    value: false
  use_early_stopping:
    value: true
  generate_scatters:
    value: true

  # Data / loader
  dataset:
    value: NCT-CRC-HE-100K
  batch_size:
    value: 64
  num_workers:
    value: 4
  image_size_global:
    value: 224
  image_size_local:
    value: 96
  mean:
    value: [0.7406, 0.5331, 0.7059]
  std:
    value: [0.1651, 0.2174, 0.1574]
  out_path:
    value: ../out/dino_ref

  # Encoder (DINOv3)
  model_id:
    value: facebook/dinov3-vitb16-pretrain-lvd1689m
  use_hf_normalize:
    value: false
  use_stain_norm:
    value: false
  stain_norm_method:
    value: reinhard
  stain_target_means_lab:
    value: [50.0, 0.0, 0.0]
  stain_target_stds_lab:
    value: [15.0, 5.0, 5.0]
  # Backbone training controls
  grad_checkpointing:
    value: true
  unfreeze_last_n:
    value: -1
  backbone_lr_mult:
    value: 0.1
  backbone_lr:
    value: null

  # Head dimensions
  head_hidden_dim:
    value: 512
  head_bottleneck_dim:
    value: 64
  head_output_dim:
    value: 2048
  freeze_last_layer_epochs:
    value: 1

  # Training schedule
  epochs:
    value: 100
  optimizer:
    value: adamw
  learning_rate:
    value: 5e-4
  weight_decay:
    value: 0.04
  weight_decay_cosine:
    value: true
  weight_decay_end:
    value: 0.0
  warmup_epochs:
    value: 10
  lr_schedule:
    value: cosine
  scale_lr_with_batch:
    value: true
  base_batch_size:
    value: 256

  # DINO-specific (teacher/student)
  num_global_views:
    value: 2
  n_local_views:
    value: 6
  global_crop_scale:
    value: [0.4, 1.0]
  local_crop_scale:
    value: [0.05, 0.4]

  # Temperatures / centering / EMA
  teacher_temp_warmup:
    value: 0.04
  teacher_temp_final:
    value: 0.07
  student_temp:
    value: 0.1
  center_momentum:
    value: 0.9
  teacher_temp_per_step:
    value: true
  warmup_teacher_temp_steps:
    value: 0              # 0 = auto from epochs * steps/epoch
  ema_momentum_start:
    value: 0.996
  ema_momentum_end:
    value: 0.9995

  # Augmentations (histology-friendly)
  use_ref_aug_policy:
    value: true
  cj_prob:
    value: 0.8
  cj_strength:
    value: 0.5
  cj_bright:
    value: 0.8
  cj_contrast:
    value: 0.8
  cj_sat:
    value: 0.4
  cj_hue:
    value: 0.2
  random_gray_scale:
    value: 0.2
  gaussian_blur:              # [prob_global1, prob_global2, prob_local]
    value: [1.0, 0.1, 0.5]
  solarization_prob:
    value: 0.2

  # Logging / metrics
  loss_fn_switch:
    value: DinoLoss
  error_metric_name:
    value: DinoLoss

  # Runtime
  precision_auto:
    value: true
  ddp_find_unused_parameters_false:
    value: true
  use_fused_adamw:
    value: true
